
((digest . "f83bf6a211f5416127759de833527a35") (undo-list nil (1229 . 1230) (")" . -1229) (1229 . 1230) (t 23269 31076 0 0) nil (1228 . 1229) (")" . -1228) (")" . 1229) (1228 . 1229) (" " . -1228) (1228 . 1229) (")" . -1228) (1228 . 1229) nil (")" . -1218) ((marker . 1230) . -1) ((marker* . 1229) . 1) ((marker . 1230) . -1) ((marker . 1230) . -1) 1219 nil (1217 . 1218) ("(" . -1217) (1217 . 1219) ("(" . -1217) (1214 . 1218) (t 23269 31052 0 0) nil (993 . 994) ("(" . 987) (986 . 987) (986 . 987) ("(" . -992) (992 . 993) nil (983 . 986) (t 23269 31027 0 0) nil ("*(" . 989) ((marker . 1230) . -1) ((marker* . 1229) . 1) ((marker . 1230) . -1) ((marker* . 1213) . 1) ((marker . 1230) . -1) (990 . 991) ("()" . 990) ((marker* . 1229) . 2) ((marker* . 1213) . 1) ((marker . 1230) . -2) (990 . 991) ("(" . 990) ((marker* . 1229) . 1) ((marker . 1230) . -1) ((marker* . 1213) . 1) nil (983 . 991) nil (977 . 983) nil ("88201," . -977) ((marker . 986) . -6) ((marker . 1230) . -6) ((marker . 977) . -6) ((marker . 977) . -6) ((marker . 977) . -6) ((marker . 977) . -6) ((marker . 977) . -6) ((marker . 977) . -6) ((marker . 977) . -6) 983 nil ("period*(" . -983) ((marker . 1230) . -8) ((marker . 977) . -7) ((marker . 977) . -7) ((marker . 977) . -7) ((marker . 977) . -7) ((marker . 977) . -7) ((marker . 977) . -7) ((marker) . -7) 991 nil (990 . 991) ("(" . -990) ((marker . 977) . -1) (990 . 992) ("(" . -990) ((marker . 977) . -1) ((marker . 977) . -1) (989 . 991) (t 23269 31027 0 0) nil ("
" . -904) ((marker . 986) . -1) ((marker . 904) . -1) ((marker . 1230) . -1) ((marker . 1198) . -1) ("    
    csv_reader = pd.read_csv(input_file,header=None,encoding=\"utf_8\")" . -905) ((marker . 904) . -9) ((marker . 1230) . -74) ((marker) . -74) ((marker* . 1229) . 1) ((marker . 1230) . -74) ((marker* . 1213) . 41) ((marker . 1230) . -74) ((marker . 1198) . -5) 979 (t 23269 31012 0 0) nil (864 . 879) ("inputfilepre" . -864) ((marker . 1230) . -12) 876 nil (873 . 876) nil (864 . 873) ("inputfil" . -864) ((marker . 1230) . -8) 872 nil (869 . 872) nil (864 . 869) nil ("inputfile" . -864) ((marker . 1230) . -9) 873 (t 23269 30992 0 0) nil (1135 . 1145) ("input_fi" . -1135) ((marker . 1230) . -8) 1143 nil (1140 . 1143) nil (1135 . 1140) ("inpu" . -1135) ((marker . 1230) . -4) 1139 nil (1134 . 1139) ("(" . -1134) (1134 . 1136) ("(" . -1134) (1134 . 1135) nil ("(" . -1134) ((marker . 1230) . -1) (")" . 1135) nil ("u" . -1135) ((marker . 1230) . -1) ("i" . -1136) ((marker . 1230) . -1) ("n" . -1137) ((marker . 1230) . -1) 1138 nil (1134 . 1138) ("(" . -1134) (1134 . 1136) ("(" . -1134) (1134 . 1135) nil (1129 . 1134) nil (1120 . 1129) (t 23269 30982 0 0) nil (1052 . 1058) ("peri" . -1052) ((marker . 1230) . -4) 1056 nil (1052 . 1056) nil ("6" . -1052) ((marker . 1230) . -1) ((marker . 977) . -1) ("0" . -1053) ((marker . 1230) . -1) ((marker . 977) . -1) 1054 (t 23269 30925 0 0) nil (1309 . 1310) 1259 nil ("9" . -1257) ((marker . 1230) . -1) 1258 nil (1255 . 1258) ("[" . -1255) (1255 . 1257) ("[" . -1255) (1248 . 1256) nil ("s" . -1248) ((marker . 1230) . -1) ("t" . -1249) ((marker . 1230) . -1) ("r" . -1250) ((marker . 1230) . -1) 1251 nil (989 . 996) nil ("c" . -989) ((marker . 1230) . -1) ("a" . -990) ((marker . 1230) . -1) 991 nil (989 . 991) nil ("text." . -989) ((marker . 1230) . -5) 994 nil ("txt" . -994) ((marker . 1230) . -3) 997 nil (" # ファイルを閉じる" . 1276) nil (" # 引数の文字列をファイルに書き込む" . 1253) nil (1272 . 1281) nil ("    " . -1277) ((marker . 1230) . -4) 1281 nil (1273 . 1281) nil (nil rear-nonsticky nil 1292 . 1293) (1241 . 1293) nil (1232 . 1241) nil ("
" . -1018) ((marker . 1230) . -1) ((marker . 1198) . -1) 1019 nil ("f.write(str) # 引数の文字列をファイルに書き込む
f.close() # ファイルを閉じる" . 1018) ((marker . 1230) . -52) ((marker) . -52) ((marker . 1198) . -32) 1070 nil (979 . 1070) nil (974 . 979) ("    " . 974) ((marker . 1230) . -4) 978 nil (973 . 978) nil ("t" . -1197) ((marker . 1230) . -1) ("m" . -1198) ((marker . 1230) . -1) 1199 nil (1197 . 1199) nil (1188 . 1197) nil (1160 . 1166) nil ("+" . -1160) ((marker . 1230) . -1) 1161 nil (1156 . 1161) nil ("a" . -1156) ((marker . 1230) . -1) 1157 nil (1156 . 1157) nil (1167 . 1178) nil ("s" . -1167) ((marker . 1230) . -1) ("u" . -1168) ((marker . 1230) . -1) ("m" . -1169) ((marker . 1230) . -1) 1170 nil (1166 . 1170) nil ("[" . -1166) ((marker . 1230) . -1) ((marker) . -1) ("]" . 1167) ((marker) . -1) nil (1166 . 1167) ("[" . -1166) (1166 . 1168) ("[" . -1166) (1166 . 1167) nil (nil rear-nonsticky nil 1165 . 1166) (1156 . 1166) nil (1147 . 1156) nil ("
" . -1147) ((marker . 1230) . -1) ((marker . 986) . -1) ((marker . 1198) . -1) 1148 nil ("        csv_reader.sum(ac)" . 1148) ((marker . 986) . -8) nil (1170 . 1173) ("(" . -1170) (1170 . 1172) ("(" . -1170) (1166 . 1171) nil (" = pd.read_csv(input_file,header=None,encoding=\"utf_8\")" . 1166) nil (1156 . 1221) nil (1147 . 1156) nil ("(x,y) = index2zorder(column_name)
        if(value[0] >= 1):
            color = int(value[0]*10)
            cv2.rectangle(img, (x*CELL, y*CELL), (x*CELL+CELL, y*CELL+CELL), (0,0, color), -1)
" . -1165) ((marker . 1230) . -193) ((marker) . -193) ((marker . 1198) . -193) ((marker . 1231) . -193) 1358 nil ("
" . 1148) ((marker . 1231) . -1) nil ("
" . 1148) ((marker . 1231) . -1) (t 23269 30558 0 0) nil (1067 . 1072) ("'" . -1067) (1067 . 1068) ("'" . -1067) (1067 . 1069) ("'" . -1067) (1064 . 1068) nil (1058 . 1063) ("(" . -1058) (1058 . 1060) ("(" . -1058) (1055 . 1059) nil ("'" . -1055) ((marker . 1230) . -1) ("'" . 1056) nil (1055 . 1056) ("'" . -1055) (1055 . 1056) ("'" . -1055) (1055 . 1057) ("'" . -1055) (1052 . 1056) nil (nil rear-nonsticky nil 1051 . 1052) (1035 . 1052) nil (1033 . 1035) nil ("-" . -1033) ((marker . 1230) . -1) (" " . -1034) ((marker . 1230) . -1) 1035 nil (1027 . 1028) nil (1022 . 1034) nil (1013 . 1022) (t 23269 30534 0 0) nil (1007 . 1011) nil ("0" . -1007) ((marker . 1230) . -1) 1008 nil (1001 . 1003) nil (1001 . 1006) nil (1000 . 1001) ("(" . -1000) (1000 . 1002) ("(" . -1000) (998 . 1001) nil ("d" . -998) ((marker . 1230) . -1) 999 nil (995 . 999) nil ("csv_" . -995) ((marker . 1230) . -4) 999 nil ("reader." . -999) ((marker . 1230) . -7) 1006 nil ("iteritems()" . -1006) ((marker . 1230) . -11) ((marker* . 1229) . 1) ((marker . 1230) . -11) ((marker* . 1213) . 2) ((marker . 1230) . -11) 1017 nil (" " . -991) ((marker . 1230) . -1) ("=" . -992) ((marker . 1230) . -1) (" " . -993) ((marker . 1230) . -1) 994 nil (987 . 994) nil ("column_" . -987) ((marker . 1230) . -7) 994 nil ("name," . -994) ((marker . 1230) . -5) 999 nil ("value" . -999) ((marker . 1230) . -5) 1004 nil (1107 . 1116) ("        " . 1107) ((marker . 1230) . -8) 1115 nil (1106 . 1115) ("        " . 1106) ((marker . 1230) . -8) 1114 nil (1105 . 1114) nil (1040 . 1105) nil (1031 . 1040) nil ("
" . 974) ((marker . 1231) . -1) nil ("    img.fill(255)" . 974) nil ("
" . -1250) ((marker . 1230) . -1) ((marker . 1198) . -1) ("
" . -1251) ((marker . 1230) . -1) ((marker . 1198) . -1) 1252 nil ("    cv2.imwrite('./img2.jpg',img)" . 1252) nil ("
" . -303) ((marker . 1230) . -1) ((marker . 986) . -1) ((marker) . -1) ((marker . 1198) . -1) ("def index2zorder(index):
    index_bin = format(index,'016b')
    x_str = \"\"
    y_str = \"\"
    for i in range(0,8):
        x_str += index_bin[i*2 + 1]
        y_str += index_bin[i*2]
    return (int(x_str,2),int(y_str,2))" . -304) ((marker . 1230) . -223) ((marker) . -16) ((marker) . -223) ((marker* . 1229) . 1) ((marker . 1230) . -223) ((marker* . 1213) . 27) ((marker . 1230) . -223) ((marker . 1198) . -185) 527 nil ("
" . -287) ((marker . 1230) . -1) ((marker . 986) . -1) ((marker . 1198) . -1) ("GRAPH_SIZE = 4096
CELL = int(4096 / 256)
img = np.zeros((GRAPH_SIZE,GRAPH_SIZE,3),np.uint8)" . -288) ((marker . 1230) . -91) ((marker) . -91) ((marker* . 1229) . 1) ((marker . 1230) . -91) ((marker* . 1213) . 36) ((marker . 1230) . -91) ((marker . 1198) . -41) 379 nil ("
" . -234) ((marker . 1230) . -1) ((marker . 1198) . -1) 235 nil ("import cv2" . 235) (t 23269 30403 0 0) nil (1127 . 1130) nil ("-" . -1127) ((marker . 1230) . -1) (" " . -1128) ((marker . 1230) . -1) 1129 nil (1127 . 1129) nil ("-" . -1127) ((marker . 1230) . -1) ("=" . -1128) ((marker . 1230) . -1) (" " . -1129) ((marker . 1230) . -1) 1130 nil (1122 . 1130) nil (1117 . 1122) (t 23269 30394 0 0) nil (1025 . 1026) nil ("ｄ" . -1025) ((marker . 1230) . -1) (1025 . 1026) ("ｄ" . -1025) ((marker . 1230) . -1) (1025 . 1026) ("s" . -1025) ((marker . 1230) . -1) 1026 (t 23269 30212 0 0) nil (1193 . 1198) nil ("r" . -1193) ((marker . 1230) . -1) 1194 nil (1192 . 1194) nil ("_prefix" . 1192) nil ("_file" . 1192) nil ("input" . 1192) nil (1221 . 1223) nil ("o" . -1221) ((marker . 1230) . -1) ("s" . -1222) ((marker . 1230) . -1) 1223 nil (1217 . 1223) ("per" . -1217) ((marker . 1230) . -3) 1220 nil (1218 . 1220) nil (1217 . 1218) nil ("inputfil" . -1217) ((marker . 1230) . -8) 1225 nil ("e" . -1225) ((marker . 1230) . -1) 1226 nil (1192 . 1226) nil (1187 . 1192) nil (1020 . 1026) nil ("inputfileprefix" . -1020) ((marker . 1230) . -15) 1035 nil (1013 . 1014) nil ("i" . -1013) ((marker . 1230) . -1) 1014 nil (982 . 1125) nil (977 . 982) ("    " . 977) ((marker . 1230) . -4) ((marker . 650) . -4) ((marker . 650) . -4) ((marker . 650) . -4) 981 nil (976 . 981) (t 23269 30190 0 0) nil (1023 . 1030) nil (880 . 886) nil (1 . 1422) nil ("#!/usr/bin/env python
# -*- coding: utf-8 -*-

# filename : main.py
# date : 2018-04-23
# author : Yoshiki Kurihara <y-kurihara@ist.osaka-u.ac.jp>

'''
description
入力 : sumoの出力ファイル(csvパース後)
出力 : 各秒のセルに存在する自動車の台数を示す行列(ファイル名)、自動車が存在し得るセルを示す行列
'''

#import files
import pandas as pd
import numpy as np
import argparse
import sys

#DEFINE CONSTANT
# MAX_LATITUDE = 49.652578
# MIN_LATITUDE = 49.549099
# MAX_LONGTITUDE = 6.216758
# MIN_LONGTITUDE = 6.030969
MAX_LATITUDE = 49.63498657
MIN_LATITUDE = 49.56669043
MAX_LONGTITUDE = 6.18517387
MIN_LONGTITUDE = 6.06255313

CHUNK_SIZE = 10000

# DEFINE METHOD

'''
x,y座標からZorderの名前を取得する
input : coordinates [(float) lattitude,(float) lonngtitude]
output : coorinates in matrix [(int) x,(int) y] (error output [-1,-1])
'''
def search_xycoord(coord) :
    top_line = MAX_LATITUDE
    left_line =  MIN_LONGTITUDE
    right_line = MAX_LONGTITUDE
    bottom_line = MIN_LATITUDE

    x_name = \"\"
    y_name = \"\"
    for i in range(0,8):
        hor_line = (top_line + bottom_line)/2
        ver_line = (right_line + left_line)/2
        if (coord[0] > hor_line) and (coord[1] < ver_line):
            x_name += \"0\"
            y_name += \"0\"
            bottom_line = hor_line
            right_line = ver_line
        elif (coord[0] > hor_line) and (coord[1] > ver_line):
            x_name += \"1\"
            y_name += \"0\"
            bottom_line = hor_line
            left_line = ver_line
        elif (coord[0] < hor_line) and (coord[1] < ver_line):
            x_name += \"0\"
            y_name += \"1\"
            top_line = hor_line
            right_line = ver_line
        elif (coord[0] < hor_line) and (coord[1] > ver_line):
            x_name += \"1\"
            y_name += \"1\"
            top_line = hor_line
            left_line = ver_line
    if len(x_name) == 8:
        return search_zorder_index(x_name,y_name)
    else:
        print('error')
        return -1

'''
x,yの２進数表記からZ-order配列のindexを取得する
input : (string) X name (string) Y name
output : Z-order index
'''
def search_zorder_index(xname,yname):
    zname = ''
    for i in range(0,len(xname)):
        zname += yname[i]
        zname += xname[i]
    return int(zname,2)


if __name__ == '__main__' :
    
    parser = argparse.ArgumentParser(
        prog='parse-data',
        usage='parse sumo result csv to multicast area generater',
        description='description',
        epilog='end',
        add_help=True,
    )

    # (option) input file
    parser.add_argument('-i', '--inputfile',
                        help='input sumo result csv',
                        action='store',
                        required=True)
    # (option) output file
    parser.add_argument('-o', '--outputprefix',
                        help='input sumo result csv',
                        action='store',
                        required=True)
    parser.add_argument('-t', '--timelimit',
                        help='time limit',
                        action='store',
                        default=sys.maxsize,
                        required=False)

    # input arguments
    args = parser.parse_args()
    input_file = args.inputfile
    LIMIT_TIME = args.timelimit
    output_prefix = args.outputprefix

    # initiate array
    existance_bit = np.zeros(65536,dtype=int)
    matrix_vehicles = np.zeros(65536,dtype=int)

    # メモリに乗らなさそうなのでチャンクに分ける
    csv_reader = pd.read_csv(input_file,header=None,encoding=\"utf_8\",chunksize=CHUNK_SIZE)
    
    time = 0
    for chunk in csv_reader:
        for row in chunk.itertuples():

            # 存在するかしないかの行列
            if (MAX_LATITUDE < row[10]) or (MIN_LATITUDE > row[10]) or (MAX_LONGTITUDE < row[9]) or (MIN_LONGTITUDE > row[9]):
                continue
            z_index = search_xycoord([row[10],row[9]])
            if z_index == -1:
                continue
            existance_bit[z_index] = 1

            # 車の台数の行列への出力
            if time < row[1]:
                output_filename = './result/' + output_prefix + str(int(time)) + '.csv'
                np.savetxt(output_filename,matrix_vehicles,fmt=\"%.0f\",newline=',')
                matrix_vehicles = np.zeros(65536,dtype=int)
                time += 60
                print(str(time) + ': completed')

            if time == row[1]:
                matrix_vehicles[z_index] += 1
        if time > LIMIT_TIME:
            break
            
    output_filename = './result/' + output_prefix + '.existence.csv'
    np.savetxt(output_filename, existance_bit,fmt=\"%.0f\",newline=',')
" . 1) ((marker . 1262) . -601) ((marker . 986) . -4507) ((marker . 1) . -601) ((marker) . -601) ((marker) . -4507) ((marker . 1231) . -22) nil ("h" . -602) ((marker . 1230) . -1) 603 nil (602 . 603) (t 23269 30149 0 0)))
